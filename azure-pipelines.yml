# Copyright Â© 2020 TomTom NV. All rights reserved.
#
# This software is the proprietary copyright of TomTom NV and its subsidiaries and may be
# used for internal evaluation purposes or commercial use strictly subject to separate
# license agreement between you and TomTom NV. If you are the licensee, you are only permitted
# to use this software in accordance with the terms of your license agreement. If you are
# not the licensee, you are not authorized to use this software in any manner and should
# immediately return or destroy it.

# Azure pipelines documentation is available at
# https://aka.ms/yaml

variables:
  - template: private-pool-agents/private-cloud-agents.yml@devops-templates
  - template: .azure-templates/variables.yml
  # Variable groups containing the passwords used below are defined in the project's Pipelines Library.
  - group: IviArtifactoryCredentials
  # Access data required for CI pipeline to publish results from security vulnerabilities scanning.
  - group: bdtools-access-secrets
  - group: 'NavKit2ApiKey'
  # Use to limit jobs to builds of the 'master' branch, made on the pipeline whose definition id
  # is 1986 (the IndiGO Docs main pipeline).
  - name: isMainlineBuild
    value: $[ and(
      eq(variables['Build.SourceBranch'], 'refs/heads/master'),
      eq(variables['System.DefinitionId'], 1986)
      ) ]

# Trigger builds on new commits on stable branches.
# Builds from PRs are triggered by the Branch Policy in the repo settings.
# Builds on `master` are batched together when possible, to reduce the number of
# concurrent builds from merged PRs.
trigger:
  batch: true
  branches:
    include:
      - 'master'
      - 'release/*'

resources:
  containers:
  # Docker containers with run options for private cloud agents and shared Gradle caches.
  - container: docker_indigo_build
    image: 'indigo/build:$(dockerImageVersion)'
    endpoint: 'IVI-Docker'
    options: $(dockerImageDefaultOptions)
  - container: docker_indigo_test
    image: 'indigo/test:$(dockerImageVersion)'
    endpoint: 'IVI-Docker'
    options: $(dockerImageTestingOptions)
  - container: docker_indigo_scanner
    image: 'indigo/scanner:$(dockerImageVersion)'
    endpoint: 'IVI-Docker'
    options: $(dockerImageTestingOptions)
  repositories:
  - repository: devops-templates
    type: git
    name: IVI/devops-templates
    ref: refs/tags/2.1.0

pool: 'IVI 2.0'

stages:
- stage: ProductVersion
  displayName: Product version
  jobs:
  - template: .azure-templates/product-get-version.yml

- stage: Build
  displayName: 'Build pipeline'
  dependsOn: ProductVersion
  variables:
    product_version: $[ stageDependencies.ProductVersion.Version.outputs['version.product_version'] ]
  jobs:
  - template: gradle/dependencies-scan.yml@devops-templates
    parameters:
      dependenciesTaskName: showAllDependencies -PuseInternalNavkit2ApiKey=true
  - job: Build
    displayName: Lint & Build
    timeoutInMinutes: 20
    container: 'docker_indigo_build'
    steps:
    - template: .azure-templates/build-steps.yml
    - template: .azure-templates/portal_check.yml
    - template: build/build-cleanup.yml@devops-templates

  - job: UnitTests
    displayName: Unit tests
    container: 'docker_indigo_test'
    timeoutInMinutes: 15
    steps:
    - template: .azure-templates/test-unit.yml
    - template: build/build-cleanup.yml@devops-templates

  - job: IntegrationTests
    displayName: Integration & E2E tests
    container: 'docker_indigo_test'
    timeoutInMinutes: 15
    steps:
    - template: .azure-templates/test-instrumented.yml
      parameters:
        artifactName: integration-test
        testTasks: >-
          runDebugAndroidTests
    - template: build/build-cleanup.yml@devops-templates

- stage: Analyse
  displayName: Analyse
  dependsOn:
    - ProductVersion
    - Build
  variables:
    product_version: $[ stageDependencies.ProductVersion.Version.outputs['version.product_version'] ]
  jobs:
  - job: SonarQube
    displayName: Run SonarQube analysis
    container: 'docker_indigo_build'
    steps:
    - template: .azure-templates/sonarqube-steps.yml

- stage: OSSCompliance
  dependsOn: ProductVersion
  condition: and(eq(variables.isMainlineBuild, true), succeeded())
  displayName: OSS compliance scan
  variables:
    product_version: $[ stageDependencies.ProductVersion.Version.outputs['version.product_version'] ]
  jobs:
  - job: OSSComplianceScan
    displayName: OSS compliance scan
    container: docker_indigo_scanner
    steps:
    - bash: |
        set -eux
        echo -e "\nnavkit2ApiKey=$(NAVKIT2_API_KEY)" >> $(Build.SourcesDirectory)/gradle.properties
      displayName: configure navkit2api key for scan
    - template: oss/scan-and-report.yml@devops-templates
      parameters:
        conf_file_path: .azure-templates/bdtools.yml
        product: ivi-indigo-docs
        product_version: $(product_version)
        report_filename: products_indigo_examples
        artifactory_location: products_indigo_examples
        bdtools_environment: prod
        run_compliancecheck: true

- stage: Publishing
  condition: and(eq(variables.isMainlineBuild, true), succeeded())
  dependsOn:
    - ProductVersion
    - Build
  variables:
    product_version: $[ stageDependencies.ProductVersion.Version.outputs['version.product_version'] ]
  jobs:
  - job: Publish
    container: 'docker_indigo_build'
    displayName: Publish artifacts
    steps:
    - template: .azure-templates/publishing.yml

  - job: PublishRepository
    displayName: Publishing Repository to Artifactory
    dependsOn: Publish
    condition: and(eq(variables.isMainlineBuild, true), succeeded())
    container: 'docker_indigo_build'
    variables:
      product_version: $[ stageDependencies.ProductVersion.Version.outputs['version.product_version'] ]
    steps:
    - bash: |
        set -eux
        ls -1A | xargs -d "\n" tar cfz products_indigo_examples-$(product_version)-sources.tar.gz
      displayName: Archive repository to tar
    - template: publish/push-to-artifactory.yml@devops-templates
      parameters:
        currentProductVersion: "$(product_version)"
        workingDirectory: "$(Build.SourcesDirectory)"
        artifactId: "products_indigo_examples"
        folderOrFileName: "products_indigo_examples-$(product_version)-sources.tar.gz"
        condition: and(eq(variables.isMainlineBuild, true), succeeded())
