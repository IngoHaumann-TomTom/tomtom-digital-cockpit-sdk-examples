# Copyright Â© 2020 TomTom NV. All rights reserved.
#
# This software is the proprietary copyright of TomTom NV and its subsidiaries and may be
# used for internal evaluation purposes or commercial use strictly subject to separate
# license agreement between you and TomTom NV. If you are the licensee, you are only permitted
# to use this software in accordance with the terms of your license agreement. If you are
# not the licensee, you are not authorized to use this software in any manner and should
# immediately return or destroy it.

# Azure pipelines documentation is available at
# https://aka.ms/yaml

steps:
- checkout: self
  persistCredentials: true

- bash: |
    set -eux

    echo "Product version: $(product_version)"

    version_tag=$(gitversion /nocache /verbosity error /showvariable SemVer)
    version_branch=$(Build.SourceBranchName)

    if [[ "$version_tag" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]] && [[ "$version_branch" =~ ^(master|release/.+)$ ]]
    then
      :
    else
      echo "Publication is not allowed, version_tag=\"$version_tag\", version_branch=\"$version_branch\"." >&2
      exit 1
    fi
  displayName: 'Check version can be published'

- download: current
  artifact: builds

- template: gradle/gradle.yml@devops-templates
  parameters:
    tasks: >-
      artifactoryPublish
    projectOptions:
      -PpublishUsername=$(ARTIFACTORY_USERNAME)
      -PpublishPassword=$(ARTIFACTORY_PASSWORD)
      -PiviVersion=$(product_version)
      -PuseInternalNavkit2ApiKey=true
    displayName: Publish APKs to Artifactory
    condition: succeeded()

- bash: |
    set -eu
    git config --global user.email "ivi_dev@groups.tomtom.com"
    git config --global user.name "Azure DevOps"
    echo "Tagging commit with $(product_version)"
    git tag "$(product_version)"
    git push origin "$(product_version)"
  displayName: Tag commit
  condition: succeeded()
