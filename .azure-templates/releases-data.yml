# Copyright Â© 2022 TomTom NV. All rights reserved.
#
# This software is the proprietary copyright of TomTom NV and its subsidiaries and may be
# used for internal evaluation purposes or commercial use strictly subject to separate
# license agreement between you and TomTom NV. If you are the licensee, you are only permitted
# to use this software in accordance with the terms of your license agreement. If you are
# not the licensee, you are not authorized to use this software in any manner and should
# immediately return or destroy it.

parameters:
  # Location of the releases.json file on Artifactory.
  urlReleasesJsonFile: 'https://artifactory.navkit-pipeline.tt3.com/artifactory/ivi-maven/com/tomtom/ivi/releases-data/tomtom-indigo-sdk/releases.json'

steps:
  - checkout: indigo
  - checkout: indigoqa

  - template: download/download-and-verify.yml@devops-templates
    parameters:
      downloadUrl: ${{parameters.urlReleasesJsonFile}}
      displayName: 'Download releases json file from Artifactory'
      userName: $(ARTIFACTORY_USERNAME)
      password: $(ARTIFACTORY_PASSWORD)
      downloadDirectory: $(Build.SourcesDirectory)/indigo-qa/tooling/Sdk/
      checksumType: 'sha256'

  - task: PythonScript@0
    name: Releases
    displayName: 'Update releases data'
    inputs:
      scriptSource: 'filePath'
      scriptPath: $(Build.SourcesDirectory)/indigo-qa/tooling/Sdk/update_releases_data.py
      pythonInterpreter: /usr/bin/python3
      workingDirectory: $(Build.SourcesDirectory)/indigo-qa/tooling/Sdk/
      arguments:
        --jira_user $(JIRA_USERNAME)
        --jira_pass $(JIRA_PASSWORD)
        --repo $(Build.SourcesDirectory)/indigo
        --previous_platform_version $(PREVIOUS_PRODUCT_VERSION)
        --platform_version $(VERSION_PLATFORM)
        --examples_version $(versionExamples)
        --tomtom_android_tools_version $(VERSION_TOMTOM_ANDROID_TOOLS)
        --indigo_comms_sdk_version $(VERSION_COMMUNICATIONS_SDK)
    condition: and(eq(variables.isMainlineBuild, true), succeeded())

  - bash: |
      set -eux
      curl -X PUT -u '$(ARTIFACTORY_USERNAME):$(ARTIFACTORY_PASSWORD)'\
        -T releases.json\
        ${{parameters.urlReleasesJsonFile}}
      rm releases.json
    workingDirectory: $(Build.SourcesDirectory)/indigo-qa/tooling/Sdk/
    displayName: 'Publish releases json file to Artifactory'
    condition: and(eq(variables.isMainlineBuild, true), succeeded())
