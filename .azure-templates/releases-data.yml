# Copyright Â© 2022 TomTom NV. All rights reserved.
#
# This software is the proprietary copyright of TomTom NV and its subsidiaries and may be
# used for internal evaluation purposes or commercial use strictly subject to separate
# license agreement between you and TomTom NV. If you are the licensee, you are only permitted
# to use this software in accordance with the terms of your license agreement. If you are
# not the licensee, you are not authorized to use this software in any manner and should
# immediately return or destroy it.

parameters:
  # Location of the releases.json file on Artifactory.
  urlReleasesJsonFile: 'https://artifactory.navkit-pipeline.tt3.com/artifactory/ivi-maven/com/tomtom/ivi/releases-data/tomtom-indigo-sdk/releases.json'

steps:
  - checkout: indigo
  - checkout: indigoqa

  - task: DownloadPipelineArtifact@2
    inputs:
      artifact: jira-tickets
      path: $(Build.SourcesDirectory)/indigo-qa/tooling/Sdk
    displayName: 'Download the jira-tickets artifact'
    condition: and(eq(variables.publishLibraries, '--publish_libs'), succeeded())

  - template: download/download-and-verify.yml@devops-templates
    parameters:
      downloadUrl: ${{parameters.urlReleasesJsonFile}}
      displayName: 'Download releases json file from Artifactory'
      userName: $(IVI_ARTIFACTORY_USERNAME)
      password: $(IVI_ARTIFACTORY_PASSWORD)
      downloadDirectory: $(Build.SourcesDirectory)/indigo-qa/tooling/Sdk
      checksumType: 'sha256'

  - task: PythonScript@0
    name: Releases
    displayName: 'Update releases data'
    inputs:
      scriptSource: 'filePath'
      scriptPath: $(Build.SourcesDirectory)/indigo-qa/tooling/Sdk/update_releases_data.py
      pythonInterpreter: /usr/bin/python3
      workingDirectory: $(Build.SourcesDirectory)/indigo-qa/tooling/Sdk
      arguments:
        --platform_version $(VERSION_PLATFORM)
        --examples_version $(VERSION_EXAMPLES)
        --tomtom_android_tools_version $(VERSION_TOMTOM_ANDROID_TOOLS)
        --indigo_comms_sdk_version $(VERSION_COMMUNICATIONS_SDK)
        --releases_file_path releases.json
        --tickets_file_path tickets.json
    condition: and(eq(variables.isMainlineBuild, true), succeeded())

  - publish: $(Build.SourcesDirectory)/indigo-qa/tooling/Sdk/releases.json
    artifact: releases-info
    displayName: 'Publish releases.json as artifact'
    condition: and(ne(variables['Agent.JobStatus'], 'Canceled'), ne(variables['Agent.JobStatus'], 'Failed'), ne(variables['Agent.JobStatus'], 'SucceededWithIssues'))

  - bash: |
      set -eux
      curl -X PUT -u '$(IVI_ARTIFACTORY_USERNAME):$(IVI_ARTIFACTORY_PASSWORD)'\
        -T releases.json\
        ${{parameters.urlReleasesJsonFile}}
      rm releases.json
    workingDirectory: $(Build.SourcesDirectory)/indigo-qa/tooling/Sdk/
    displayName: 'Publish releases json file to Artifactory'
    condition: and(eq(variables.isMainlineBuild, true), succeeded())
