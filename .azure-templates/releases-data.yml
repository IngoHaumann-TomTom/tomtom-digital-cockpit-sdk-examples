# Copyright Â© 2020 TomTom NV. All rights reserved.
#
# This software is the proprietary copyright of TomTom NV and its subsidiaries and may be
# used for internal evaluation purposes or commercial use strictly subject to separate
# license agreement between you and TomTom NV. If you are the licensee, you are only permitted
# to use this software in accordance with the terms of your license agreement. If you are
# not the licensee, you are not authorized to use this software in any manner and should
# immediately return or destroy it.

parameters:
  # Location of the releases.json file on Artifactory.
  urlReleasesJsonFile: 'https://artifactory.navkit-pipeline.tt3.com/artifactory/ivi-maven/com/tomtom/ivi/releases-data/tomtom-indigo-sdk/releases.json'

steps:
  - template: download/download-and-verify.yml@devops-templates
    parameters:
      downloadUrl: ${{parameters.urlReleasesJsonFile}}
      displayName: 'Download releases json file from Artifactory'
      userName: $(ARTIFACTORY_USERNAME)
      password: $(ARTIFACTORY_PASSWORD)
      downloadDirectory: $(Build.SourcesDirectory)
      checksumType: 'sha256'

  # TODO(IVI-6139): Generate release notes in the SDK release pipeline
  - task: PythonScript@0
    displayName: 'Update releases data'
    inputs:
      scriptSource: 'inline'
      pythonInterpreter: /usr/bin/python3
      arguments:
        --version_platform $(Version.INDIGO_PLATFORM)
        --version_examples $(versionExamples)
        --version_tomtom_android_tools $(Version.API_TOMTOM_ANDROID_TOOLS)
        --version_indigo_comms_sdk $(Version.API_INDIGO_COMMS_SDK)
      script: |
        import argparse
        from datetime import datetime
        import json

        parser = argparse.ArgumentParser(description='Script to update releases data.')
        parser.add_argument("--version_platform", dest="version_platform")
        parser.add_argument("--version_examples", dest="version_examples")
        parser.add_argument("--version_tomtom_android_tools", dest="version_tomtom_android_tools")
        parser.add_argument("--version_indigo_comms_sdk", dest="version_indigo_comms_sdk")
        args = parser.parse_args()

        sdk_version = f"{args.version_platform}-{args.version_examples.split('.')[-1]}"
        with open('releases.json', 'r+') as json_file:
            data = json.load(json_file)
            data.append({
              sdk_version: {
                  "indigoPlatform": args.version_platform,
                  "exampleApp": args.version_examples,
                  "tomtomAndroidTools": args.version_tomtom_android_tools,
                  "iviCommunicationsSdk": args.version_indigo_comms_sdk,
                  "releaseNotes": [],
                  "date": datetime.now().strftime("%m/%d/%Y, %H:%M:%S")
              }
            })
            json_file.seek(0)
            json.dump(data, json_file, indent=4)

  - bash: |
      set -eux
      curl -X PUT -u '$(ARTIFACTORY_USERNAME):$(ARTIFACTORY_PASSWORD)'\
        -T releases.json\
        ${{parameters.urlReleasesJsonFile}}
      rm releases.json
    displayName: 'Publish releases json file to Artifactory'
