# Copyright Â© 2020 TomTom NV. All rights reserved.
#
# This software is the proprietary copyright of TomTom NV and its subsidiaries and may be
# used for internal evaluation purposes or commercial use strictly subject to separate
# license agreement between you and TomTom NV. If you are the licensee, you are only permitted
# to use this software in accordance with the terms of your license agreement. If you are
# not the licensee, you are not authorized to use this software in any manner and should
# immediately return or destroy it.

# Azure pipelines documentation is available at
# https://aka.ms/yaml

parameters:
  # Folder for the internal example source (should have been prepared for release before this).
  internalExampleSourceFolder: ''

steps:
  - checkout: indigoqa

  - bash: |
      set -eux
      # This ensures no context is kept from previous runs on the same agent.
      rm -rf $(Build.SourcesDirectory)/downloads
      mkdir $(Build.SourcesDirectory)/downloads
    displayName: Create download directory

  - task: DownloadSecureFile@1
    name: caCertificate
    displayName: 'Download CA certificate'
    inputs:
      secureFile: 'publishindigodocs.private-key.pem'

  - bash: |
      set -eu

      if [ "$(PUBLISH_DOCUMENTATION)" = "True" ]
      then
        echo "##vso[task.setvariable variable=externalRepoBranch]main"
        echo "##vso[task.setvariable variable=versionTag]$(VERSION_PLATFORM)-$(PATCH_VERSION_EXAMPLES)"
      else
        echo "##vso[task.setvariable variable=externalRepoBranch]beta"
        echo "##vso[task.setvariable variable=versionTag]$(VERSION_PLATFORM)-$(PATCH_VERSION_EXAMPLES)-beta"
      fi

      commitMessage='TomTom IndiGO SDK Release $(VERSION_PLATFORM)-$(PATCH_VERSION_EXAMPLES)'
      echo "##vso[task.setvariable variable=commitMessage]$commitMessage"

  - script: |
      ruby $(Build.SourcesDirectory)/indigo-qa/tooling/Sdk/indigo_platform_publishing_app.rb \
        --download_base_path=$(System.DefaultWorkingDirectory)/downloads \
        --internal_source_folder=${{parameters.internalExampleSourceFolder}} \
        --external_repo_name="tomtom-international/tomtom-indigo-sdk-examples" \
        --external_repo_branch=$(externalRepoBranch) \
        --github_app_identifier=$(GITHUB_APP_IDENTIFIER) \
        --github_app_installation_identifier=$(GITHUB_APP_INSTALLATION_IDENTIFIER) \
        --github_app_private_key_path=$(caCertificate.secureFilePath) \
        --version_examples=$(VERSION_EXAMPLES) \
        --version_tag=$(versionTag) \
        --commit_message="$(commitMessage)"
    name: GithubPublish
    displayName: 'Publish example sources to github'
