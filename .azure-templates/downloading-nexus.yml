# Copyright (c) 2020 - 2021 TomTom N.V. All rights reserved.
#
# This software is the proprietary copyright of TomTom N.V. and its subsidiaries and may be
# used for internal evaluation purposes or commercial use strictly subject to separate
# licensee agreement between you and TomTom. If you are the licensee, you are only permitted
# to use this Software in accordance with the terms of your license agreement. If you are
# not the licensee then you are not authorised to use this software in any manner and should
# immediately return it to TomTom N.V.

# Azure pipelines documentation is available at
# https://aka.ms/yaml

parameters:
  nexusUrl: https://repo.tomtom.com/repository/ivi
  iviGroup: com/tomtom/ivi
  indigoGroup: com/tomtom/indigo

steps:
- template: download/download-and-verify.yml@devops-templates
  parameters:
    downloadUrl: ${{parameters.nexusUrl}}/${{parameters.iviGroup}}/lineageos-gts4lvwifi/$(VERSION_LINEAGEOS)/lineageos-gts4lvwifi-$(VERSION_LINEAGEOS)-ota.zip
    displayName: Download and verify AAOS system image for tablet
    userName: $(NEXUS_USERNAME)
    password: $(NEXUS_PASSWORD)

- download: current
  artifact: repo-sys-img

  # Since it is not possible to upload this xml file to a root folder on Nexus (400 Invalid path for
  # a Maven 2 repository), upload this file to Azure Blob using a dedicated container as a temporary
  # solution. So that external customers can download the latest version of the IndiGO AAOS system
  # images for emulators, while needing to setup their environment only once.
  # TODO(IVI-3803): Upload the repo-sys-img.xml file to the developer portal
- task: AzureCLI@2
  inputs:
    azureSubscription: '$(SUBSCRIPTION_ID)'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      az storage copy \
      --source $(Pipeline.Workspace)/repo-sys-img/repo-sys-img.xml \
      --account-name $(ACCOUNT_NAME) \
      --account-key $(ACCOUNT_KEY) \
      --destination-container indigo-automotive
  displayName: Upload repo-sys-img.xml to Azure Storage

  # TODO(IVI-3803): Upload the repo-sys-img.xml file to the developer portal
- bash: |
    set -eux
    curl -Lo repo-sys-img.xml https://aaos.blob.core.windows.net/indigo-automotive/repo-sys-img.xml
  displayName: Download repo-sys-img.xml file

- task: PythonScript@0
  name: getEmulatorDownloadLinks
  inputs:
    scriptSource: 'inline'
    pythonInterpreter: /usr/bin/python3
    script: |
      import xml.dom.minidom as md

      repo_sys_img_xml_file = "$(Build.SourcesDirectory)/repo-sys-img.xml"
      content = md.parse(repo_sys_img_xml_file)
      center_display_image = content.getElementsByTagName("url")[0].firstChild.nodeValue
      cluster_display_image = content.getElementsByTagName("url")[1].firstChild.nodeValue
      print(f"##vso[task.setvariable variable=center;isOutput=true]{center_display_image}")
      print(f"##vso[task.setvariable variable=cluster;isOutput=true]{cluster_display_image}")
  displayName: Get download urls from repo-sys-img file

- template: download/download-and-verify.yml@devops-templates
  parameters:
    downloadUrl: $(getEmulatorDownloadLinks.center)
    displayName: Download and verify AAOS system image for emulator (center display)
    userName: $(NEXUS_USERNAME)
    password: $(NEXUS_PASSWORD)

- template: download/download-and-verify.yml@devops-templates
  parameters:
    downloadUrl: $(getEmulatorDownloadLinks.cluster)
    displayName: Download and verify AAOS system image for emulator (cluster display)
    userName: $(NEXUS_USERNAME)
    password: $(NEXUS_PASSWORD)

- template: download/download-and-verify.yml@devops-templates
  parameters:
    downloadUrl: ${{parameters.nexusUrl}}/${{parameters.indigoGroup}}/tomtom-indigo-sdk/$(VERSION_PLATFORM)/tomtom-indigo-sdk-$(VERSION_PLATFORM).tar.gz
    displayName: Download and verify SDK archive
    userName: $(NEXUS_USERNAME)
    password: $(NEXUS_PASSWORD)

- task: ExtractFiles@1
  inputs:
    archiveFilePatterns: '**/*.tar.gz'
    destinationFolder: '$(Build.SourcesDirectory)/downloads/sdk'
    cleanDestinationFolder: false
    overwriteExistingFiles: false
  displayName: Extract tomtom-indigo-sdk-$(VERSION_PLATFORM).tar.gz
