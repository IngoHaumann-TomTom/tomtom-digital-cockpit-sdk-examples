# Copyright (c) 2020 - 2021 TomTom N.V. All rights reserved.
#
# This software is the proprietary copyright of TomTom N.V. and its subsidiaries and may be
# used for internal evaluation purposes or commercial use strictly subject to separate
# licensee agreement between you and TomTom. If you are the licensee, you are only permitted
# to use this Software in accordance with the terms of your license agreement. If you are
# not the licensee then you are not authorised to use this software in any manner and should
# immediately return it to TomTom N.V.

# Azure pipelines documentation is available at
# https://aka.ms/yaml

parameters:
  nexusUrl: https://repo.tomtom.com/repository/ivi
  iviGroup: com/tomtom/ivi
  indigoGroup: com/tomtom/indigo

steps:
- template: download/download-and-verify.yml@devops-templates
  parameters:
    downloadUrl: ${{parameters.nexusUrl}}/${{parameters.iviGroup}}/lineageos-gts4lvwifi/$(VERSION_LINEAGEOS)/lineageos-gts4lvwifi-$(VERSION_LINEAGEOS)-ota.zip
    displayName: Download and verify AAOS system image for tablet
    userName: $(NEXUS_USERNAME)
    password: $(NEXUS_PASSWORD)

- template: download/download-and-verify.yml@devops-templates
  parameters:
    downloadUrl: ${{parameters.nexusUrl}}/${{parameters.iviGroup}}/Android-Automotive-11-Emulator/$(VERSION_EMULATOR)/Android-Automotive-11-Emulator-$(VERSION_EMULATOR).xml
    displayName: Download and verify repo-sys-img.xml file
    userName: $(NEXUS_USERNAME)
    password: $(NEXUS_PASSWORD)

- task: PythonScript@0
  name: getEmulatorDownloadLink
  inputs:
    scriptSource: 'inline'
    pythonInterpreter: /usr/bin/python3
    script: |
      import xml.dom.minidom as md

      repo_sys_img_xml_file = "$(Build.SourcesDirectory)/downloads/Android-Automotive-11-Emulator-11.xml"
      content = md.parse(repo_sys_img_xml_file)
      url_to_test = content.getElementsByTagName("sdk:url")[0].firstChild.nodeValue
      print(f"##vso[task.setvariable variable=url;isOutput=true]{url_to_test}")
  displayName: Get download url from repo-sys-img file

- template: download/download-and-verify.yml@devops-templates
  parameters:
    downloadUrl: $(getEmulatorDownloadLink.url)
    displayName: Download and verify AAOS system image for emulator
    userName: $(NEXUS_USERNAME)
    password: $(NEXUS_PASSWORD)

- template: download/download-and-verify.yml@devops-templates
  parameters:
    downloadUrl: ${{parameters.nexusUrl}}/${{parameters.indigoGroup}}/sdk/$(VERSION_SDK)/sdk-$(VERSION_SDK).tar.gz
    displayName: Download and verify SDK archive
    userName: $(NEXUS_USERNAME)
    password: $(NEXUS_PASSWORD)

- task: ExtractFiles@1
  inputs:
    archiveFilePatterns: '**/*.tar.gz'
    destinationFolder: '$(Build.SourcesDirectory)/downloads/sdk'
    cleanDestinationFolder: false
    overwriteExistingFiles: false
  displayName: Extract sdk-$(VERSION_SDK).tar.gz

- task: ExtractFiles@1
  inputs:
    archiveFilePatterns: '**/*.tar.gz'
    destinationFolder: '$(Build.SourcesDirectory)/downloads/sdk/examples/sources'
    cleanDestinationFolder: false
    overwriteExistingFiles: false
  displayName: Extract the sources
