# Copyright Â© 2020 TomTom NV. All rights reserved.
#
# This software is the proprietary copyright of TomTom NV and its subsidiaries and may be
# used for internal evaluation purposes or commercial use strictly subject to separate
# license agreement between you and TomTom NV. If you are the licensee, you are only permitted
# to use this software in accordance with the terms of your license agreement. If you are
# not the licensee, you are not authorized to use this software in any manner and should
# immediately return or destroy it.

# Azure pipelines documentation is available at
# https://aka.ms/yaml

steps:
  - checkout: ivi-example-app
  - checkout: indigoqa
  - checkout: indigo

  - bash: |
      set -eux
      # This ensures no context is kept from previous runs on the same agent.
      rm -rf $(Build.SourcesDirectory)/downloads
      mkdir $(Build.SourcesDirectory)/downloads
    displayName: Create download directory

    # Download artifacts from Artifactory by providing the version of the artifact, and publish
    # these to Nexus. The values of the parameters below can be entered from the pipeline's UI.
  - task: PythonScript@0
    name: Nexus
    displayName: Publish artifacts to Nexus
    inputs:
      scriptSource: 'filePath'
      scriptPath: $(Build.SourcesDirectory)/indigo-qa/tooling/Sdk/indigo.py
      pythonInterpreter: /usr/bin/python3.8
      arguments:
        --nexus_user $(NEXUS_USERNAME)
        --nexus_pass $(NEXUS_PASSWORD)
        --artifactory_user $(ARTIFACTORY_USERNAME)
        --artifactory_pass $(ARTIFACTORY_PASSWORD)
        --version_examples $(versionExamples)
        --version_lineageos $(versionLineageOs)
        --download_base_path $(System.DefaultWorkingDirectory)/downloads
        --indigo_sources_path $(Build.SourcesDirectory)/indigo
        $(publishLibraries)
        $(publishLineageOsImage)
        $(publishEmulatorImages)

  # TODO(IVI-3803): Upload the repo-sys-img.xml file to the developer portal
  - publish: $(Build.SourcesDirectory)/downloads/com/tomtom/ivi/ivi-automotive-sdk/android-11/repo-sys-img.xml
    artifact: repo-sys-img
    displayName: Publish the repo-sys-img.xml file as a pipeline artifact
    condition: and(eq(variables.publishEmulatorImages, '--publish_emulators'), succeeded())

  - publish: $(System.DefaultWorkingDirectory)/downloads/tomtom-indigo-sdk-$(Nexus.indigoPlatform)-$(Nexus.PATCH_VERSION_EXAMPLES).tar.gz
    artifact: tomtom-indigo-sdk
    displayName: Publish tomtom-indigo-sdk as a pipeline artifact
    condition: and(eq(variables.publishLibraries, '--publish_libs'), succeeded())
