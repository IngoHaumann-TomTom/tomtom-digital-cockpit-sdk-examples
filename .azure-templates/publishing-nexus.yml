# Copyright Â© 2020 TomTom NV. All rights reserved.
#
# This software is the proprietary copyright of TomTom NV and its subsidiaries and may be
# used for internal evaluation purposes or commercial use strictly subject to separate
# license agreement between you and TomTom NV. If you are the licensee, you are only permitted
# to use this software in accordance with the terms of your license agreement. If you are
# not the licensee, you are not authorized to use this software in any manner and should
# immediately return or destroy it.

# Azure pipelines documentation is available at
# https://aka.ms/yaml

steps:
  - checkout: ivi-example-app
  - checkout: indigoqa
  - checkout: indigo

  - bash: |
      set -eux
      # This ensures no context is kept from previous runs on the same agent.
      rm -rf $(Build.SourcesDirectory)/downloads
      mkdir $(Build.SourcesDirectory)/downloads
    displayName: Create download directory

  - bash: |
      set -eux
      cd $(Build.SourcesDirectory)/ivi-example-app
      git checkout tags/$(VERSION_EXAMPLES)
    displayName: Checkout example-app $(VERSION_EXAMPLES)

    # Download artifacts from Artifactory by providing the version of the artifact, and publish
    # these to Nexus. The values of the parameters below can be entered from the pipeline's UI.
  - task: PythonScript@0
    name: Nexus
    displayName: Publish artifacts to Nexus
    inputs:
      scriptSource: 'filePath'
      scriptPath: $(Build.SourcesDirectory)/indigo-qa/tooling/Sdk/indigo.py
      pythonInterpreter: /usr/bin/python3.8
      arguments:
        --nexus_user $(NEXUS_USERNAME)
        --nexus_pass $(NEXUS_PASSWORD)
        --artifactory_user $(IVI_ARTIFACTORY_USERNAME)
        --artifactory_pass $(IVI_ARTIFACTORY_PASSWORD)
        --version_examples $(VERSION_EXAMPLES)
        --version_lineageos $(versionLineageOs)
        --download_base_path $(System.DefaultWorkingDirectory)/downloads
        --indigo_sources_path $(Build.SourcesDirectory)/indigo
        $(publishLibraries)
        $(publishLineageOsImage)
        $(publishEmulatorImages)

  # TODO(IVI-3803): Upload the repo-sys-img.xml file to the developer portal
  - publish: $(Build.SourcesDirectory)/downloads/com/tomtom/ivi/ivi-automotive-sdk/android-11/repo-sys-img.xml
    artifact: repo-sys-img
    displayName: Publish the repo-sys-img.xml file as a pipeline artifact
    condition: and(eq(variables.publishEmulatorImages, '--publish_emulators'), succeeded())

    # Since it is not possible to upload this xml file to a root folder on Nexus (400 Invalid path for
    # a Maven 2 repository), upload this file to Azure Blob using a dedicated container as a temporary
    # solution. So that external customers can download the latest version of the IndiGO AAOS system
    # images for emulators, while needing to setup their environment only once.
    # TODO(IVI-3803): Upload the repo-sys-img.xml file to the developer portal
  - task: AzureCLI@2
    inputs:
      azureSubscription: '$(SUBSCRIPTION_ID)'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        az storage copy \
        --source $(Build.SourcesDirectory)/downloads/com/tomtom/ivi/ivi-automotive-sdk/android-11/repo-sys-img.xml \
        --account-name $(ACCOUNT_NAME) \
        --account-key $(ACCOUNT_KEY) \
        --destination-container tomtom-digital-cockpit
    displayName: Upload repo-sys-img.xml to Azure Storage
    condition: and(eq(variables.publishEmulatorImages, '--publish_emulators'), succeeded())

  - publish: $(System.DefaultWorkingDirectory)/downloads/tomtom-indigo-sdk-$(Nexus.iviPlatform)-$(Nexus.PATCH_VERSION_EXAMPLES).tar.gz
    artifact: tomtom-indigo-sdk
    displayName: Publish tomtom-indigo-sdk as a pipeline artifact
    condition: and(eq(variables.publishLibraries, '--publish_libs'), succeeded())
