# Copyright Â© 2022 TomTom NV. All rights reserved.
#
# This software is the proprietary copyright of TomTom NV and its subsidiaries and may be
# used for internal evaluation purposes or commercial use strictly subject to separate
# license agreement between you and TomTom NV. If you are the licensee, you are only permitted
# to use this software in accordance with the terms of your license agreement. If you are
# not the licensee, you are not authorized to use this software in any manner and should
# immediately return or destroy it.

steps:
  - checkout: ivi-example-app
  - checkout: indigo

  - bash: |
      # Do not use "set -eux" here, otherwise vso commands below will contain an extra quote at the end
      set -e

      if [ $(versionExamples) == 'latest' ]
      then
        EXAMPLES=$(BuildTags.versionExamples)
      else
        EXAMPLES=$(versionExamples)
      fi

      cd $(Build.SourcesDirectory)/ivi-example-app
      git checkout tags/$EXAMPLES
      examplesTomlFilePath=build-logic/libraries.versions.toml
      INDIGO_PLATFORM=$(cat $examplesTomlFilePath | grep "indigoPlatform = " | grep -Eo "[0-9].[0-9].[0-9]+")

      cd $(Build.SourcesDirectory)/indigo
      git checkout tags/$INDIGO_PLATFORM
      indigoTomlFilePath=build-logic/libraries.versions.toml
      NAVKIT2_CORE_BOM=$(cat $indigoTomlFilePath | grep "navKit2CoreBomNavApp = " | grep -Eo "[0-9]+.[0-9]+.[0-9]+")
      NAVAPP_COMPONENTS=$(cat $indigoTomlFilePath | grep "navAppComponents = " | grep -Eo "[0-9]+.[0-9]+.[0-9]+")
      TOMTOM_ANDROID_TOOLS=$(cat $examplesTomlFilePath | grep "tomtomAndroidTools = " | grep -Eo "[0-9].[0-9].[0-9]+")
      INDIGO_COMMS_SDK=$(cat $examplesTomlFilePath | grep "iviCommunicationsSdk = " | grep -Eo "[0-9].[0-9].[0-9]+")
      NAVTEST=$(cat $examplesTomlFilePath | grep "navtest = " | grep -Eo "[0-9]+.[0-9]+.[0-9]+")
      NAVUI_EMULATORS=$(cat $examplesTomlFilePath | grep "navuiEmulators = " | grep -Eo "[0-9]+.[0-9]+.[0-9]+")
      ALEXA_AUTO_SDK=$(cat $examplesTomlFilePath | grep "amazonAlexaAutoSdk = " | grep -Eo "[0-9]+.[0-9]+.[0-9]+")

      echo "##vso[task.setvariable variable=EXAMPLES;isOutput=true]$EXAMPLES"
      echo "##vso[task.setvariable variable=INDIGO_PLATFORM;isOutput=true]$INDIGO_PLATFORM"
      echo "##vso[task.setvariable variable=TOMTOM_ANDROID_TOOLS;isOutput=true]$TOMTOM_ANDROID_TOOLS"
      echo "##vso[task.setvariable variable=INDIGO_COMMS_SDK;isOutput=true]$INDIGO_COMMS_SDK"
      echo "##vso[task.setvariable variable=NAVTEST;isOutput=true]$NAVTEST"
      echo "##vso[task.setvariable variable=NAVUI_EMULATORS;isOutput=true]$NAVUI_EMULATORS"
      echo "##vso[task.setvariable variable=NAVKIT2_CORE_BOM;isOutput=true]$NAVKIT2_CORE_BOM"
      echo "##vso[task.setvariable variable=NAVAPP_COMPONENTS;isOutput=true]$NAVAPP_COMPONENTS"
      echo "##vso[task.setvariable variable=ALEXA_AUTO_SDK;isOutput=true]$ALEXA_AUTO_SDK"

      echo "##vso[build.addbuildtag]versionExamples=$EXAMPLES"
      echo "##vso[build.addbuildtag]indigoPlatform=$INDIGO_PLATFORM"
      echo "##vso[build.addbuildtag]navKit2CoreBomNavApp=$NAVKIT2_CORE_BOM"
      echo "##vso[build.addbuildtag]navAppComponents=$NAVAPP_COMPONENTS"
    name: Version
    displayName: 'Expose versions to Azure'
    condition: succeeded()

  - task: PythonScript@0
    name: CompareVersions
    displayName: 'Compare IndiGO platform versions'
    inputs:
      scriptSource: 'inline'
      pythonInterpreter: /usr/bin/python3.8
      script: |
        from semantic_version import Version

        release_allowed = True
        if Version("$(Version.INDIGO_PLATFORM)") <= Version("$(PREVIOUS_PRODUCT_VERSION)"):
          print(
            "##vso[task.logissue type=warning;]Not allowed to release platform for version "
            "[$(Version.INDIGO_PLATFORM)]! Previously the platform has been already successfully "
            "released for version [$(PREVIOUS_PRODUCT_VERSION)], which is the same or newer."
          )
          release_allowed = False
        print(f"##vso[task.setvariable variable=releaseAllowed;isOutput=true]{release_allowed}")
    condition: succeeded()

