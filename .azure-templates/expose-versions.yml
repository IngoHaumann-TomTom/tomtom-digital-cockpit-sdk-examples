# Copyright Â© 2022 TomTom NV. All rights reserved.
#
# This software is the proprietary copyright of TomTom NV and its subsidiaries and may be
# used for internal evaluation purposes or commercial use strictly subject to separate
# license agreement between you and TomTom NV. If you are the licensee, you are only permitted
# to use this software in accordance with the terms of your license agreement. If you are
# not the licensee, you are not authorized to use this software in any manner and should
# immediately return or destroy it.

steps:
  - checkout: ivi-example-app
  - checkout: indigo

  - bash: |
      # Do not use "set -eux" here, otherwise vso commands below will contain an extra quote at the end
      set -e

      if [ $(versionExamples) == 'latest' ]
      then
        EXAMPLES=$(BuildTags.versionExamples)
      else
        EXAMPLES=$(versionExamples)
      fi

      cd $(Build.SourcesDirectory)/ivi-example-app
      git checkout tags/$EXAMPLES
      examplesTomlFilePath=build-logic/libraries.versions.toml
      IVI_PLATFORM=$(cat $examplesTomlFilePath | grep "iviPlatform = " | grep -Eo "[0-9].[0-9].[0-9]+")

      cd $(Build.SourcesDirectory)/indigo
      git checkout tags/$IVI_PLATFORM
      indigoTomlFilePath=build-logic/libraries.versions.toml
      NAVAPP_COMPONENTS=$(cat $indigoTomlFilePath | grep "navAppComponents = " | grep -Eo "[0-9]+.[0-9]+.*[^\"]")
      TOMTOM_ANDROID_TOOLS=$(cat $examplesTomlFilePath | grep "tomtomAndroidTools = " | grep -Eo "[0-9].[0-9].[0-9]+")
      IVI_COMMS_SDK=$(cat $examplesTomlFilePath | grep "iviCommunicationsSdk = " | grep -Eo "[0-9].[0-9].[0-9]+")
      NAVTEST=$(cat $examplesTomlFilePath | grep "navtest = " | grep -Eo "[0-9]+.[0-9]+.[0-9]+")
      NAVUI_EMULATORS=$(cat $examplesTomlFilePath | grep "navuiEmulators = " | grep -Eo "[0-9]+.[0-9]+.[0-9]+")
      ALEXA_AUTO_SDK=$(cat $examplesTomlFilePath | grep "amazonAlexaAutoSdk = " | grep -Eo "[0-9]+.[0-9]+.[0-9]+")

      echo "##vso[task.setvariable variable=EXAMPLES;isOutput=true]$EXAMPLES"
      echo "##vso[task.setvariable variable=IVI_PLATFORM;isOutput=true]$IVI_PLATFORM"
      echo "##vso[task.setvariable variable=TOMTOM_ANDROID_TOOLS;isOutput=true]$TOMTOM_ANDROID_TOOLS"
      echo "##vso[task.setvariable variable=IVI_COMMS_SDK;isOutput=true]$IVI_COMMS_SDK"
      echo "##vso[task.setvariable variable=NAVTEST;isOutput=true]$NAVTEST"
      echo "##vso[task.setvariable variable=NAVUI_EMULATORS;isOutput=true]$NAVUI_EMULATORS"
      echo "##vso[task.setvariable variable=NAVAPP_COMPONENTS;isOutput=true]$NAVAPP_COMPONENTS"
      echo "##vso[task.setvariable variable=ALEXA_AUTO_SDK;isOutput=true]$ALEXA_AUTO_SDK"

      echo "##vso[build.addbuildtag]versionExamples=$EXAMPLES"
      echo "##vso[build.addbuildtag]indigoPlatform=$IVI_PLATFORM"
      echo "##vso[build.addbuildtag]navAppComponents=$NAVAPP_COMPONENTS"
    name: Version
    displayName: 'Expose versions to Azure'
    condition: and(succeeded(), ne(variables['BuildTags.buildTagsMatched'], 'False'))
