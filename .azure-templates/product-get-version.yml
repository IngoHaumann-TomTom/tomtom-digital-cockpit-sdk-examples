# Copyright Â© 2020 TomTom NV. All rights reserved.
#
# This software is the proprietary copyright of TomTom NV and its subsidiaries and may be
# used for internal evaluation purposes or commercial use strictly subject to separate
# license agreement between you and TomTom NV. If you are the licensee, you are only permitted
# to use this software in accordance with the terms of your license agreement. If you are
# not the licensee, you are not authorized to use this software in any manner and should
# immediately return or destroy it.

# Azure pipelines documentation is available at
# https://aka.ms/yaml

steps:
  - bash: |
      set -eux

      version_semver=$(gitversion /nocache /verbosity error /showvariable FullSemVer)
      test -n "$version_semver"

      echo "Product version: \"$version_semver\""

      # Work-around for Azure bug: Disable the shell flag '-x' now , to prevent single-quote appended to values.
      # https://developercommunity.visualstudio.com/content/problem/375679/pipeline-variable-incorrectly-inserts-single-quote.html
      set +x

      if [ $(Build.Reason) == 'PullRequest' ]
      then
        sourceBranch=$(echo $(System.PullRequest.SourceBranch) |sed 's@/@_@g')
        echo "##vso[task.setvariable variable=platform_version;isOutput=true]$sourceBranch-$(System.PullRequest.sourceCommitId)"
      else
        echo "##vso[task.setvariable variable=platform_version;isOutput=true]$(PRODUCT_VERSION)"
      fi

      # Export the version information to the next steps using VSO task variables.
      echo "##vso[task.setvariable variable=product_version;isOutput=true]$version_semver"
    displayName: 'Parse version info'
    name: version
