# Copyright Â© 2020 TomTom NV. All rights reserved.
#
# This software is the proprietary copyright of TomTom NV and its subsidiaries and may be
# used for internal evaluation purposes or commercial use strictly subject to separate
# license agreement between you and TomTom NV. If you are the licensee, you are only permitted
# to use this software in accordance with the terms of your license agreement. If you are
# not the licensee, you are not authorized to use this software in any manner and should
# immediately return or destroy it.

# Azure pipelines documentation is available at
# https://aka.ms/yaml

parameters:
  # Name for the artifacts produced (should be unique within pipeline).
  artifactName: ''
  # Remote branch to check out.
  branch: ''
  # List of instrumented tests to run.
  testTasks: ''
  # The amount of emulators to be started using one avd.
  nrOfEmulators: 1

steps:
  - template: checkout-branch.yml
    parameters:
      branch: ${{parameters.branch}}

  - template: gradle/gradle.yml@devops-templates
    parameters:
      tasks: >-
        killEmulators
        deleteEmulators
        createEmulators
        startEmulators
      projectOptions: >-
        -PuseInternalNavkit2ApiKey=true
        -Pemulators=${{parameters.nrOfEmulators}}
        -PemulatorDirectory=$(Build.SourcesDirectory)/TestAVDs
      displayName: 'Start emulators'

  - template: gradle/gradle-with-tests.yml@devops-templates
    parameters:
      tasks: ${{parameters.testTasks}}
      projectOptions: >-
        --max-workers=12
        -PuseInternalNavkit2ApiKey=true
      testResultsFiles: '**/androidTest*/**/TEST-*.xml'
      testRunTitle: 'Tests'
      displayName: 'Run tests'
      condition: succeeded()

  - template: gradle/gradle.yml@devops-templates
    parameters:
      tasks: >-
        pullDeviceDebugInfo
      projectOptions: >-
        -PuseInternalNavkit2ApiKey=true
      displayName: 'Retrieve emulator logs and metadata'
      condition: succeededOrFailed()

  - template: publish/publish-pipeline-artifact.yml@devops-templates
    parameters:
      contents: |
        IviTest/**
        deviceLogs/**
      displayName: 'Publish test results'
      artifact: ${{parameters.artifactName}}-results
      condition: succeededOrFailed()

  - template: gradle/gradle.yml@devops-templates
    parameters:
      tasks: >-
        killEmulators
        deleteEmulators
      projectOptions: >-
        -PuseInternalNavkit2ApiKey=true
      displayName: 'Stop emulators'
      condition: always()
