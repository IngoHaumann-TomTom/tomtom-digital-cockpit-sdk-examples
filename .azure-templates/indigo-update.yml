# Copyright Â© 2020 TomTom NV. All rights reserved.
#
# This software is the proprietary copyright of TomTom NV and its subsidiaries and may be
# used for internal evaluation purposes or commercial use strictly subject to separate
# license agreement between you and TomTom NV. If you are the licensee, you are only permitted
# to use this software in accordance with the terms of your license agreement. If you are
# not the licensee, you are not authorized to use this software in any manner and should
# immediately return or destroy it.

# Azure pipelines documentation is available at
# https://aka.ms/yaml

parameters:
  branch: 'indigo-platform-canary'
  newIviPlatformVersion: ''

steps:
  - bash: |
      set -eux
      if [[ -z "${{parameters.branch}}" ]] || [[ "${{parameters.branch}}" == "master" ]] || [[ "${{parameters.branch}}" == release* ]]
      then
        echo "Parameter branch=${{parameters.branch}} not allowed."
        exit 1
      fi
    displayName: 'Check job parameters'

  - checkout: self
    persistCredentials: true
    clean: true

  - template: gradle/gradle.yml@devops-templates
    parameters:
      tasks: >-
        generateIviPlatformLibrariesVersionFile
      projectOptions: >-
        -PartifactoryBaseUrl=$(artifactoryBaseUrl)
        -PartifactoryUser=$(artifactoryUser)
        -PartifactoryToken=$(artifactoryToken)
        -PlatestIviPlatformVersion=${{parameters.newIviPlatformVersion}}
        -PuseInternalAutomotiveUiApiKey=true
      displayName: 'Check for new IVI Platform versions'

  - bash: |
      set -eux
      REPO_VERSION_OLD_FILE="./build-logic/libraries.versions.toml"
      REPO_VERSION_NEW_FILE="./libraries.versions.toml"
      if [ ! -f $REPO_VERSION_NEW_FILE ]
      then
        echo "No IVI Platform update file was found."
        exit 1
      fi
      if ! grep -qs iviPlatform ${REPO_VERSION_NEW_FILE}
      then
        echo "${REPO_VERSION_NEW_FILE} does not contain an IVI Platform version."
        exit 1
      fi

      OLD_PLATFORM_VERSION="$(grep "iviPlatform = " ${REPO_VERSION_OLD_FILE} | awk '{split($0,a," "); print a[3]}')"
      NEW_PLATFORM_VERSION="$(grep "iviPlatform = " ${REPO_VERSION_NEW_FILE} | awk '{split($0,a," "); print a[3]}')"

      if [ "${OLD_PLATFORM_VERSION}" = "${NEW_PLATFORM_VERSION}" ]
      then
        echo "No IVI Platform update was found."
        exit 1
      fi

      # Work-around for Azure bug: Disable the shell flag '-x' now , to prevent single-quote appended to values.
      # https://developercommunity.visualstudio.com/content/problem/375679/pipeline-variable-incorrectly-inserts-single-quote.html
      set +x

      git config --global user.email "ivi_dev@groups.tomtom.com"
      git config --global user.name "Azure DevOps"
      git branch -D ${{parameters.branch}} || true
      git checkout -b ${{parameters.branch}}
      echo "##vso[task.setvariable variable=branchCreated]True"
      mv ${REPO_VERSION_NEW_FILE} ${REPO_VERSION_OLD_FILE}
      git diff > $(Build.ArtifactStagingDirectory)/indigo-update.patch
      git commit -a -m "Last integrated version of IVI Platform: ${NEW_PLATFORM_VERSION}"
    displayName: 'Commit updated IVI Platform lib to ${{parameters.branch}} branch'

  - bash: |
      set -eux
      git push -f origin ${{parameters.branch}}
    displayName: 'Push ${{parameters.branch}} branch to origin'
    condition: eq(variables['branchCreated'], 'True')

  - task: PublishPipelineArtifact@1
    displayName: Publish libraries update patch as artifact
    inputs:
      targetPath: '$(Build.ArtifactStagingDirectory)/indigo-update.patch'
      artifactName: indigo-update.patch
    condition: eq(variables['branchCreated'], 'True')

  - bash: |
      set -eux
      git checkout master
      git branch -D ${{parameters.branch}}
    displayName: 'Clean up local branches'
    condition: eq(variables['branchCreated'], 'True')
