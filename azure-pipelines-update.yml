# Copyright (c) 2020 - 2021 TomTom N.V. All rights reserved.
#
# This software is the proprietary copyright of TomTom N.V. and its subsidiaries and may be
# used for internal evaluation purposes or commercial use strictly subject to separate
# licensee agreement between you and TomTom. If you are the licensee, you are only permitted
# to use this Software in accordance with the terms of your license agreement. If you are
# not the licensee then you are not authorised to use this software in any manner and should
# immediately return it to TomTom N.V.

# Azure pipelines documentation is available at
# https://aka.ms/yaml

variables:
  - template: private-pool-agents/private-cloud-agents.yml@devops-templates
  - template: .azure-templates/variables.yml
  - name: indigoBranchName
    value: indigo-platform-canary

trigger: none

resources:
  pipelines:
  - pipeline: indigo_trigger
    project: IVI
    source: IndiGO
    trigger:
      branches:
       include:
         - master
         - releases/*
  containers:
    # Docker containers with run options for private cloud agents and shared Gradle caches.
    - container: docker_indigo_build
      image: 'indigo/build:$(dockerImageVersion)'
      endpoint: 'IVI-Docker'
      options: $(dockerImageDefaultOptions)
  repositories:
    - repository: devops-templates
      type: git
      name: IVI/devops-templates

pool: 'Private Cloud CPU'

stages:

- stage: PrepareIndigoBranch
  displayName: IndiGO branch preparation
  jobs:
  - job: PrepareIndigoBranch
    displayName: Preparing IndiGO branch
    container: 'docker_indigo_build'
    steps:
    - template: .azure-templates/indigo-update.yml
      parameters:
        branch: $(indigoBranchName)

- stage: Build
  displayName: 'Build pipeline'
  dependsOn: PrepareIndigoBranch
  jobs:
    - job: Build
      displayName: 'Build'
      timeoutInMinutes: '15'
      container: 'docker_indigo_build'
      steps:
        - bash: |
            set -eux
            git checkout origin/$(indigoBranchName)
        - template: gradle/gradle.yml@devops-templates
          parameters:
            tasks: build
            displayName: 'Build'
            condition: succeeded()
        - template: build/build-cleanup.yml@devops-templates
          parameters:
            condition: always()

- stage: MergeIndigoBranch
  displayName: IndiGO branch merge
  dependsOn: Build
  jobs:
  - job: MergeIndigoBranch
    displayName: Merge IndiGO canary branch
    container: 'docker_indigo_build'
    steps:
    - template: .azure-templates/merge-feature-branch.yml
      parameters:
        branch: $(indigoBranchName)

- stage: Clean
  displayName: Clean
  dependsOn: MergeIndigoBranch
  condition: always()
  jobs:
  - job: RemoveBranch
    displayName: Remove IndiGO branch
    container: 'docker_indigo_build'
    steps:
    - checkout: self
      persistCredentials: true
    - bash: |
        set -eux
        git push --delete origin $(indigoBranchName) || true
