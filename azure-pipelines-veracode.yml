# Copyright Â© 2022 TomTom NV. All rights reserved.
#
# This software is the proprietary copyright of TomTom NV and its subsidiaries and may be
# used for internal evaluation purposes or commercial use strictly subject to separate
# license agreement between you and TomTom NV. If you are the licensee, you are only permitted
# to use this software in accordance with the terms of your license agreement. If you are
# not the licensee, you are not authorized to use this software in any manner and should
# immediately return or destroy it.

# Azure pipelines documentation is available at
# https://aka.ms/yaml

pool: 'Private Cloud Small'

trigger: none

resources:
  pipelines:
    - pipeline: veracode_scan_exampleapp
      source: IndiGO Docs
      trigger:
        branches:
          include:
            - master
            - releases/*
        stages:
          - Build
  containers:
    # Docker containers with run options for private cloud agents and shared Gradle caches.
    - container: docker_indigo_build
      image: 'indigo/build:$(dockerImageVersion)'
      endpoint: 'IVI-Docker'
      options: $(dockerImageDefaultOptions)
  repositories:
    - repository: devops-templates
      type: git
      name: IVI/devops-templates
      ref: refs/tags/2.2.4

variables:
  - template: .azure-templates/variables.yml
  - template: private-pool-agents/private-cloud-agents.yml@devops-templates

stages:
  - stage: VeracodeScan
    displayName: Veracode scan for Indigo APK
    jobs:
      - job: Veracode
        timeoutInMinutes: 160
        displayName: Download Example app APK and Scan
        container: 'docker_indigo_build'
        steps:
          - task: DownloadPipelineArtifact@2
            displayName: Download example app debug APK
            inputs:
              buildType: 'specific'
              project: 'IVI'
              definition: '1986'
              buildVersionToDownload: 'latestFromBranch'
              branchName: 'refs/heads/master'
              allowPartiallySucceededBuilds: true
              artifact: 'builds'
              targetPath: '$(Build.ArtifactStagingDirectory)/APK'
          - bash: |
              set -eu
              apkFilepath=$(find $(Build.ArtifactStagingDirectory)/APK -name "*x86_64-debug*.apk")

              if [ -z $apkFilepath ]
              then
                echo "APK file not found."
                exit 1
              fi
              cd "$( dirname "$(find $ANDROID_SDK_ROOT/build-tools/* -name aapt | head -n 1)" )"
              output=$(./aapt dump badging $apkFilepath | grep versionName)
              apkVersion=$(echo $output | grep -Po '(?<=versionName=).*?(?= )' | tr -d "'")
              echo "##vso[task.setvariable variable=scanFilePath]${apkFilepath}"
              echo "APK file to be scanned : $apkFilepath"

              if [ -z $apkVersion ]
              then
                echo "APK version is not found."
                exit 1
              fi
              echo "##vso[task.setvariable variable=productVersion]${apkVersion}"
              echo "Product version fetched from APK : $apkVersion"
            displayName: Fetch product version from APK
          - template: veracode/veracode-scan.yml@devops-templates
            parameters:
              waitTimeIntervalInSeconds: 300
              applicationName: ivi-example-app
              applicationVersion: $(productVersion)
              scanFilePath: $(scanFilePath)
              failBuildOnPolicyFail: true
              maximumWaitTime: 150
